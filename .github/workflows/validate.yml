name: validate

on:
  push:
    branches: [main]
  pull_request:
    branches: '**'

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:

    - uses: actions/checkout@v3

    - uses: cachix/install-nix-action@v22
      with:
        extra_nix_config: "system-features = nixos-test benchmark big-parallel kvm"

    - name: build
      run: NIXPKGS_ALLOW_UNFREE=1 nix build --impure

    - name: check flake (runs tests)
      run: NIXPKGS_ALLOW_UNFREE=1 nix flake check --impure --log-format internal-json

    - name: show flake output attributes
      run: nix flake show

    - name: show flake metadata
      run: nix flake metadata

    - name: launcher version
      run: ./result/bin/launcher version

    - name: osqueryd version
      run: ./result/bin/osqueryd --version
